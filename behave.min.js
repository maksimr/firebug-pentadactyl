(function(){var l=l||function(l){"function"!==typeof String.prototype.repeat&&(String.prototype.repeat=function(b){if(1>b)return"";if(b%2)return this.repeat(b-1)+this;b=this.repeat(b/2);return b+b});"function"!==typeof Array.prototype.filter&&(Array.prototype.filter=function(b,c){if(null===this)throw new TypeError;var a=Object(this),e=a.length>>>0;if("function"!=typeof b)throw new TypeError;for(var d=[],h=0;h<e;h++)if(h in a){var j=a[h];b.call(c,j,h,a)&&d.push(j)}return d});var d={textarea:null,replaceTab:!0,
softTabs:!0,tabSize:4,autoOpen:!0,overwrite:!0,autoStrip:!0,autoIndent:!0,fence:!1},k,n,j=[{open:'"',close:'"',canBreak:!1},{open:"'",close:"'",canBreak:!1},{open:"(",close:")",canBreak:!1},{open:"[",close:"]",canBreak:!0},{open:"{",close:"}",canBreak:!0}],e={defineNewLine:function(){var b=document.createElement("textarea");b.value="\n";n=2==b.value.length?"\r\n":"\n"},cursor:{get:function(){if("number"===typeof document.createElement("textarea").selectionStart)return d.textarea.selectionStart;if(document.selection){var b=
0,c=d.textarea.createTextRange(),a=document.selection.createRange().duplicate().getBookmark();for(c.moveToBookmark(a);0!==c.moveStart("character",-1);)b++;return b}if("undefined"!==typeof d.textarea.selectionEnd)return d.textarea.selectionEnd},set:function(b,c){c||(c=b);if(d.textarea.setSelectionRange)d.textarea.focus(),d.textarea.setSelectionRange(b,c);else if(d.textarea.createTextRange){var a=d.textarea.createTextRange();a.collapse(!0);a.moveEnd("character",c);a.moveStart("character",b);a.select()}},
selection:function(){var b=d.textarea,c=0,a=0,g,f,h;if("number"==typeof b.selectionStart&&"number"==typeof b.selectionEnd)c=b.selectionStart,a=b.selectionEnd;else if((f=document.selection.createRange())&&f.parentElement()==b)g=e.editor.get(),h=g.length,a=b.createTextRange(),a.moveToBookmark(f.getBookmark()),b=b.createTextRange(),b.collapse(!1),-1<a.compareEndPoints("StartToEnd",b)?c=a=h:(c=-a.moveStart("character",-h),c+=g.slice(0,c).split(n).length-1,-1<a.compareEndPoints("EndToEnd",b)?a=h:(a=-a.moveEnd("character",
-h),a+=g.slice(0,a).split(n).length-1));return c==a?!1:{start:c,end:a}}},editor:{get:function(){return d.textarea.value.replace(/\r/g,"")},set:function(b){d.textarea.value=b}},fenceRange:function(){if("string"==typeof d.fence){for(var b=e.editor.get(),c=e.cursor.get(),a=0,g=b.indexOf(d.fence),f=0;0<=g;){f++;if(c<g+a)break;a+=g+d.fence.length;b=b.substring(g+d.fence.length);g=b.indexOf(d.fence)}return a<c&&g+a>c&&0===f%2?!0:!1}return!0},isEven:function(b,c){return c%2},levelsDeep:function(){var b=
e.cursor.get(),b=e.editor.get().substring(0,b),c=0,a,g;for(a=0;a<b.length;a++)for(g=0;g<j.length;g++)j[g].canBreak&&(j[g].open==b.charAt(a)&&c++,j[g].close==b.charAt(a)&&c--);var d=0,h=["'",'"'];for(a in j)if(j[a].canBreak)for(g in h)d+=b.split(h[g]).filter(e.isEven).join("").split(j[a].open).length-1;g=c-d;return 0<=g?g:0},deepExtend:function(b,c){for(var a in c)c[a]&&c[a].constructor&&c[a].constructor===Object?(b[a]=b[a]||{},e.deepExtend(b[a],c[a])):b[a]=c[a];return b},addEvent:function(b,c,a){b.addEventListener?
b.addEventListener(c,a,!1):b.attachEvent&&b.attachEvent("on"+c,a)},preventDefaultEvent:function(b){b.preventDefault?b.preventDefault():b.returnValue=!1}},s=function(b){if(e.fenceRange()){if(9==b.keyCode){e.preventDefaultEvent(b);var c=e.cursor.selection(),a=e.cursor.get(),d=e.editor.get();if(c){for(a=c.start;a--;)if("\n"==d.charAt(a)){c.start=a+1;break}var a=d.substring(c.start,c.end),a=a.split("\n"),f;if(b.shiftKey)for(f=0;f<a.length;f++)a[f].substring(0,k.length)==k&&(a[f]=a[f].substring(k.length));
else for(f in a)a[f]=k+a[f];a=a.join("\n");e.editor.set(d.substring(0,c.start)+a+d.substring(c.end));e.cursor.set(c.start,c.start+a.length)}else if(f=d.substring(0,a),c=d.substring(a),f=f+k+c,b.shiftKey)d.substring(a-k.length,a)==k&&(f=d.substring(0,a-k.length)+c,e.editor.set(f),e.cursor.set(a-k.length));else return e.editor.set(f),e.cursor.set(a+k.length),!1}return!0}},t=function(b){if(e.fenceRange()&&13==b.keyCode){e.preventDefaultEvent(b);b=e.cursor.get();var c=e.editor.get(),a=c.substring(0,b),
c=c.substring(b),d=a.charAt(a.length-1),f=c.charAt(0),h=e.levelsDeep(),m="",l="",p;if(h){for(;h--;)m+=k;h=m.length+1;for(p in j)j[p].open==d&&j[p].close==f&&(l=n)}else h=1;p=a+n+m+l+m.substring(0,m.length-k.length)+c;e.editor.set(p);e.cursor.set(b+h)}},u=function(b){if(e.fenceRange()&&8==b.keyCode&&!1===e.cursor.selection()){var c=e.cursor.get(),a=e.editor.get(),d=a.substring(0,c),f=a.substring(c),d=d.charAt(d.length-1),f=f.charAt(0),h;for(h in j)if(j[h].open==d&&j[h].close==f){e.preventDefaultEvent(b);
var k=a.substring(0,c-1)+a.substring(c+1);e.editor.set(k);e.cursor.set(c-1)}}},q={openedChar:function(b,c){e.preventDefaultEvent(c);var a=e.cursor.get(),g=e.editor.get(),f=g.substring(0,a),g=g.substring(a);d.textarea.value=f+b.open+b.close+g;e.cursor.set(a+1)},closedChar:function(b,c){var a=e.cursor.get();return e.editor.get().substring(a,a+1)==b.close?(e.preventDefaultEvent(c),e.cursor.set(e.cursor.get()+1),!0):!1}},r={filter:function(b){if(e.fenceRange()){var c=String.fromCharCode(""!==b.which?
b.which:b.keyCode),a;for(a in j)j[a].close==c?(!d.overwrite||!q.closedChar(j[a],b))&&(j[a].open==c&&d.autoOpen)&&q.openedChar(j[a],b):j[a].open==c&&d.autoOpen&&q.openedChar(j[a],b)}},listen:function(){d.replaceTab&&e.addEvent(d.textarea,"keydown",s);d.autoIndent&&e.addEvent(d.textarea,"keydown",t);d.autoStrip&&e.addEvent(d.textarea,"keydown",u);e.addEvent(d.textarea,"keypress",r.filter)}};this.destroy=function(){d.textarea.removeEventListener("keydown",s);d.textarea.removeEventListener("keydown",
t);d.textarea.removeEventListener("keydown",u);d.textarea.removeEventListener("keypress",r.filter)};l.textarea&&(e.deepExtend(d,l),e.defineNewLine(),d.softTabs?k=" ".repeat(d.tabSize):(k="\t",d.textarea.style.tabSize=d.tabSize),r.listen())};"undefined"!==typeof dactyl&&dactyl.plugins&&(dactyl.plugins.Behave=l)})();